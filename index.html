<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® KharkivAlerts: –ö–∞—Ä—Ç–∞ –ó–∞–≥—Ä–æ–∑</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white; line-height: 1.6; min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 15px; }
        
        /* –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        header { 
            text-align: center; background: rgba(255, 255, 255, 0.08); 
            padding: 20px; border-radius: 15px; margin-bottom: 15px; 
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
        }
        h1 { color: #ff6b6b; margin-bottom: 5px; font-size: 2.2em; }
        .subheader { color: #ccc; margin-bottom: 10px; font-size: 1.1em; }
        
        /* –°–¢–ê–¢–£–° –û–ù–õ–ê–ô–ù/–û–§–õ–ê–ô–ù */
        .status-online { color: #00FF00; font-weight: bold; }
        
        .stats-container { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; margin-bottom: 15px; 
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 12px; 
            text-align: center; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-number { font-size: 2.2em; font-weight: bold; color: #ff6b6b; margin-bottom: 8px; }
        .stat-label { color: #ccc; font-size: 0.85em; }
        
        .map-container { 
            background: rgba(255, 255, 255, 0.08); padding: 15px; border-radius: 15px; 
            margin-bottom: 15px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
        }
        #alertMap { 
            height: 600px; border-radius: 10px; overflow: hidden; 
        }
        
        .alerts-container { 
            background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 15px; 
            margin-bottom: 15px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1);
        }
        .alerts-list { max-height: 400px; overflow-y: auto; }
        .alert-item { 
            background: rgba(255, 255, 255, 0.1); border-left: 5px solid #ff6b6b; padding: 15px; 
            margin: 8px 0; border-radius: 8px; transition: background 0.3s;
        }
        .alert-item:hover { background: rgba(255, 255, 255, 0.15); }

        /* –°–¢–ò–õ–Ü –î–õ–Ø –°–ú–£–ì –°–¢–ê–¢–£–°–£ (—è–∫ —É deshahed.info) */
        .alert-item.s300 { border-left-color: #e74c3c; } 
        .alert-item.iskander { border-left-color: #f39c12; } 
        .alert-item.kab { border-left-color: #9b59b6; } 
        .alert-item.shahed { border-left-color: #3498db; } 
        .alert-item.fpv { border-left-color: #1abc9c; } 
        .alert-item.artillery { border-left-color: #e67e22; } 
        .alert-item.alert { border-left-color: #f1c40f; } 

        .alert-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .alert-type { font-weight: bold; font-size: 1.1em; color: #ff6b6b; }
        .alert-time { color: #ccc; font-size: 0.8em; }
        .alert-message { margin-top: 8px; color: #eee; font-size: 0.9em; }
        .loading { text-align: center; padding: 30px; color: #ccc; }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö –ú–ê–†–ö–ï–†–û–í */
        .custom-marker {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            background-size: 70%; 
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        /* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ú–ê–†–ö–ï–†–Ü–í (–∫–æ–ª—å–æ—Ä–∏ —Ñ–æ–Ω—É) */
        .marker-s300 { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.8); }
        .marker-iskander { border-color: #f39c12; background-color: rgba(243, 156, 18, 0.8); }
        .marker-kab { border-color: #9b59b6; background-color: rgba(155, 89, 182, 0.8); }
        .marker-shahed { border-color: #3498db; background-color: rgba(52, 152, 219, 0.8); }
        .marker-fpv { border-color: #1abc9c; background-color: rgba(26, 188, 156, 0.8); }
        .marker-artillery { border-color: #e67e22; background-color: rgba(230, 126, 34, 0.8); }
        .marker-alert { border-color: #f1c40f; background-color: rgba(241, 196, 15, 0.8); }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .leaflet-pane.leaflet-overlay-pane path.shahed-line {
            stroke-width: 4px;
            stroke-dasharray: 8, 8;
            stroke-opacity: 0.8;
            stroke: #3498db; 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö® KharkivAlerts: –ö–∞—Ä—Ç–∞ –ó–∞–≥—Ä–æ–∑</h1>
            <div class="subheader">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≥—Ä–æ–∑ —É –•–∞—Ä–∫—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ. –î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤—Ä—É—á–Ω—É –∑ —Ñ–∞–π–ª—É alerts.json</div>
            <div class="last-update">
                –°—Ç–∞—Ç—É—Å: <span id="connectionStatus" class="status-online">–û–Ω–ª–∞–π–Ω</span> | 
                –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: <span id="lastUpdate">--:--:--</span> |
                –ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑: <span id="alertsCount">0</span>
            </div>
            <div style="margin-top: 10px; font-size: 0.8em; color: #ff6b6b;">
                ‚ùóÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –Ω–µ —î –æ—Ñ—ñ—Ü—ñ–π–Ω–æ—é. –°–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º–∏ –¥–∂–µ—Ä–µ–ª–∞–º–∏.
            </div>
        </header>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="activeAlerts">0</div>
                <div class="stat-label">üî¥ –ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="s300Alerts">0</div>
                <div class="stat-label">–°-300 / –°-400</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="kabAlerts">0</div>
                <div class="stat-label">üí£ –ö–ê–ë / –£–ú–ü–ë</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="shahedAlerts">0</div>
                <div class="stat-label">üõ∏ –î—Ä–æ–Ω–∏ Shahed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="iskanderAlerts">0</div>
                <div class="stat-label">üí• –Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="artilleryAlerts">0</div>
                <div class="stat-label">üî• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è / –†–°–ó–í</div>
            </div>
        </div>

        <div class="map-container">
            <div id="alertMap"></div>
        </div>

        <div class="alerts-container">
            <h2>üì¢ –û—Å—Ç–∞–Ω–Ω—ñ –∞–∫—Ç–∏–≤–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h2>
            <div id="alertsList" class="alerts-list">
                <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
            </div>
        </div>
    </div>

    <script>
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const DATA_FILE_URL = './alerts.json?v=' + Date.now(); // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
        const UPDATE_INTERVAL = 10000; // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        
        let map;
        let activeAlerts = [];
        let mapLayers = L.layerGroup();

        // –Ü–ö–û–ù–ö–ò –î–õ–Ø –ú–ê–†–ö–ï–†–Ü–í
        const TYPE_ICONS = {
            s300: 'üî¥',
            iskander: 'üí•',
            kab: 'üí£',
            shahed: 'üõ∏',
            fpv: 'üõ∞Ô∏è',
            artillery: 'üî•',
            alert: '‚ö†Ô∏è'
        };

        // –ù–ê–ó–í–ò –¢–ò–ü–Ü–í
        function getTypeName(type) {
            const names = {
                s300: 'üî¥ –†–∞–∫–µ—Ç–∞ –°-300/–°-400 (–ë–∞–ª—ñ—Å—Ç–∏–∫–∞)',
                iskander: 'üí• –†–∞–∫–µ—Ç–∞ \'–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú\'',
                kab: 'üí£ –ö–µ—Ä–æ–≤–∞–Ω–∞ –∞–≤—ñ–∞–±–æ–º–±–∞ (–ö–ê–ë/–£–ú–ü–ë)',
                shahed: 'üõ∏ –î—Ä–æ–Ω \'Shahed\' (–ì–µ—Ä–∞–Ω—å-2)',
                fpv: 'üõ∞Ô∏è FPV-–¥—Ä–æ–Ω / –†–æ–∑–≤—ñ–¥–∫–∞',
                artillery: 'üî• –ê—Ä—Ç–∏–ª–µ—Ä—ñ–π—Å—å–∫–∏–π –æ–±—Å—Ç—Ä—ñ–ª / –†–°–ó–í',
                alert: '‚ö†Ô∏è –ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞',
            };
            return names[type] || type;
        }

        // –í–†–ï–ú–Ø
        function formatTime(timestamp) {
            if (!timestamp) return '--:--:--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
        function initMap() {
            if (map) return;
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –•–∞—Ä—å–∫–æ–≤–∞
            map = L.map('alertMap').setView([49.9935, 36.2304], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(map);
            
            mapLayers.addTo(map);
        }

        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó JSON
        async function loadAlerts() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π Date.now() —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ GitHub Pages –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç —Ñ–∞–π–ª
                const response = await fetch(`./alerts.json?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.statusText}`);
                }
                const data = await response.json();
                
                processData(data);
                updateStatus('–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', true);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è alerts.json:', error);
                updateStatus(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}`, false);
            }
        }

        // –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–õ–£–ß–ï–ù–ù–´–• –î–ê–ù–ù–´–•
        function processData(data) {
            activeAlerts = data.active_alerts || [];
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            activeAlerts.sort((a, b) => b.timestamp - a.timestamp);

            updateMapMarkers();
            updateAllDisplays(data.last_update);
        }
        
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–û–í –ò –õ–ò–ù–ò–ô –ù–ê –ö–ê–†–¢–ï
        function updateMapMarkers() {
            mapLayers.clearLayers(); 

            activeAlerts.forEach(alert => {
                const markerClass = 'marker-' + alert.type;
                const iconContent = TYPE_ICONS[alert.type] || '‚ùì';
                
                const icon = L.divIcon({
                    html: `<div class="custom-marker ${markerClass}">${iconContent}</div>`,
                    className: 'custom-marker-icon',
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                });

                // –¢–æ—á–∫–∞ —Ç—Ä–µ–≤–æ–≥–∏
                const coords = Array.isArray(alert.coords) ? alert.coords : alert.coords.split(',').map(c => parseFloat(c.trim()));
                
                if (coords.length === 2) {
                    const marker = L.marker(coords, { icon: icon }).addTo(mapLayers);
                    
                    marker.bindPopup(`
                        <div style="color: black; min-width: 250px;">
                            <strong style="color: #e74c3c; font-size: 1.1em;">
                                ${getTypeName(alert.type)}
                            </strong><br>
                            <b>–õ–æ–∫–∞—Ü—ñ—è:</b> ${alert.location.replace(/_/g, ' ')}<br>
                            <b>–ß–∞—Å:</b> ${formatTime(alert.timestamp)}<br>
                            <b>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</b> ${alert.message}
                        </div>
                    `);
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ Shahed –∏ –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç, —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é
                    if (alert.type === 'shahed' && alert.direction_line && Array.isArray(alert.direction_line)) {
                        L.polyline(alert.direction_line, {
                            color: '#3498db', 
                            className: 'shahed-line',
                            weight: 3,
                            opacity: 0.8
                        }).addTo(mapLayers);
                    }
                }
            });
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
        function updateAllDisplays(lastUpdateTimestamp) {
            updateStats();
            updateAlertsList();
            updateLastUpdateTime(lastUpdateTimestamp);
        }

        function updateStats() {
            document.getElementById('activeAlerts').textContent = activeAlerts.length;
            document.getElementById('alertsCount').textContent = activeAlerts.length;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –Ω–æ–≤–∏—Ö —Ç–∏–ø—ñ–≤
            const counts = activeAlerts.reduce((acc, alert) => {
                acc[alert.type] = (acc[alert.type] || 0) + 1;
                return acc;
            }, {});

            document.getElementById('s300Alerts').textContent = counts['s300'] || 0;
            document.getElementById('kabAlerts').textContent = counts['kab'] || 0;
            document.getElementById('shahedAlerts').textContent = counts['shahed'] || 0;
            document.getElementById('iskanderAlerts').textContent = counts['iskander'] || 0;
            document.getElementById('artilleryAlerts').textContent = counts['artillery'] || 0;
            
        }

        function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            
            if (activeAlerts.length === 0) {
                alertsList.innerHTML = '<div class="loading">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑.</div>';
                return;
            }
            
            alertsList.innerHTML = '';
            activeAlerts.slice(0, 15).forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = `alert-item ${alert.type}`;
                alertElement.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-type">${getTypeName(alert.type)}</span>
                        <span class="alert-time">${formatTime(alert.timestamp)}</span>
                    </div>
                    <div class="alert-message">
                        <b>${alert.location.replace(/_/g, ' ')}:</b> ${alert.message}
                    </div>
                `;
                alertsList.appendChild(alertElement);
            });
        }

        function updateLastUpdateTime(timestampString) {
            if (timestampString) {
                document.getElementById('lastUpdate').textContent = timestampString;
            } else {
                 document.getElementById('lastUpdate').textContent = formatTime(Date.now());
            }
        }

        function updateStatus(message, isOnline) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = isOnline ? 'status-online' : 'status-offline';
        }

        // –ê–í–¢–û–ó–ê–ü–£–°–ö
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadAlerts(); // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
            setInterval(loadAlerts, UPDATE_INTERVAL); // –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        });
    </script>
</body>
</html>
